name: Auto Sync Repository

on:
  # Trigger on push to any branch
  push:
    branches:
      - '**'
  
  # Scheduled sync (hourly)
  schedule:
    - cron: '0 * * * *'  # Every hour at minute 0
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Sync mode'
        required: true
        default: 'bidirectional'
        type: choice
        options:
          - pull
          - push
          - bidirectional
      force:
        description: 'Force sync (ignore uncommitted changes)'
        required: false
        default: false
        type: boolean

# Ensure only one sync runs at a time
concurrency:
  group: sync-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sync:
    name: Sync Repository
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate sync
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "Infinity Orchestrator"
          git config --global user.email "infinity-orchestrator@infinityxone.systems"
      
      - name: ğŸ“Š Repository Status
        run: |
          echo "::group::Repository Information"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo "::endgroup::"
          
          echo "::group::Git Status"
          git status
          git log -1 --oneline
          echo "::endgroup::"
      
      - name: ğŸ”„ Fetch Remote Changes
        run: |
          git fetch origin --prune --tags
          echo "âœ“ Remote changes fetched"
      
      - name: ğŸ“¥ Pull Latest Changes
        if: github.event.inputs.mode != 'push'
        run: |
          echo "Pulling changes from origin/${{ github.ref_name }}..."
          git pull origin ${{ github.ref_name }} --rebase || {
            echo "::warning::Pull failed or had conflicts"
            exit 0
          }
          echo "âœ“ Pull completed"
      
      - name: ğŸ“¤ Push Changes
        if: github.event.inputs.mode != 'pull'
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Uncommitted changes detected, committing..."
            git add .
            git commit -m "chore: auto-sync from GitHub Actions [skip ci]" || true
          fi
          
          echo "Pushing changes to origin/${{ github.ref_name }}..."
          git push origin ${{ github.ref_name }} || {
            echo "::warning::Push failed"
            exit 0
          }
          echo "âœ“ Push completed"
      
      - name: ğŸ“ Update Active Memory
        if: always()
        run: |
          if [[ -f ".infinity/ACTIVE_MEMORY.md" ]]; then
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            MODE="${{ github.event.inputs.mode || 'auto' }}"
            
            # Update last sync timestamp
            sed -i "s/Last Sync:.*/Last Sync:** $TIMESTAMP (AUTO-SYNC) âœ…/" .infinity/ACTIVE_MEMORY.md || true
            
            # Commit the updated memory file
            if [[ -n "$(git status --porcelain .infinity/ACTIVE_MEMORY.md)" ]]; then
              git add .infinity/ACTIVE_MEMORY.md
              git commit -m "chore: update sync timestamp [skip ci]" || true
              git push origin ${{ github.ref_name }} || true
            fi
            
            echo "âœ“ ACTIVE_MEMORY.md updated"
          fi
      
      - name: âœ… Sync Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… SYNC COMPLETE"
          echo "Mode: ${{ github.event.inputs.mode || 'auto' }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Status: ${{ job.status }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸš¨ Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Auto-Sync Failed',
              body: `## Sync Failure Report
              
              **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              **Branch:** ${context.ref}
              **Event:** ${context.eventName}
              **Timestamp:** ${new Date().toISOString()}
              
              ### Details
              The automated repository sync has failed. Please review the workflow logs for details.
              
              ### Next Steps
              1. Check the workflow logs above
              2. Verify there are no merge conflicts
              3. Ensure branch protection rules are not blocking the sync
              4. Re-run the workflow manually if needed
              
              ---
              *This issue was automatically created by the Auto-Sync workflow.*`
            };
            
            // Check if a similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-sync,failure'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                ...issue,
                labels: ['auto-sync', 'failure', 'automated']
              });
            }
